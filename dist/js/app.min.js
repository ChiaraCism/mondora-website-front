!function(){var e,t={dev:{host:"localhost:3000"},prod:{host:"api.nocheros.info",debug:!0}};e=/b/.test(APP_VERSION)?t.dev:t.prod;var o=Q.defer();window.Ceres=new Asteroid(e.host,e.ssl,e.debug),Ceres.on("connected",o.resolve),Ceres.ddp.on("socket_close",function(){console.log("Closed")}),window.CERES_CONNECTED=o.promise.timeout(5e3)}(),angular.module("mnd-web",["ui.bootstrap","ui.router","mnd.sprinkle","mnd.dashboard","angularFileUpload","ngSanitize","RecursionHelper","mnd-web.templates","mnd-web.components.dashboard","mnd-web.components.mindmap","mnd-web.components.tag-strip","mnd-web.components.center","mnd-web.pages.home","mnd-web.pages.staticHome","mnd-web.pages.profile","mnd-web.pages.team","mnd-web.pages.user","mnd-web.pages.post.edit","mnd-web.pages.post.view","mnd-web.pages.post.list"]).factory("TimeoutPromiseService",["$q","$timeout","$state",function(e,t,o){var r=function(r,n){var s=e.defer(),i=t(function(){s.reject("timeout"),o.go("serverProblems")},n);return r.then(function(e){t.cancel(i),s.resolve(e)},function(e){t.cancel(i),s.reject(e),o.go("serverProblems")}),s.promise};return{timeoutPromise:r}}]).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("root",{"abstract":!0,templateUrl:"root.html",resolve:{resumingLogin:function(e,t){return CERES_CONNECTED.then(function(){var t=Ceres.resumeLoginPromise;return t.isPending()?e.timeoutPromise(t,5e3).finally(function(){return!0}):!0}).fail(function(){t.go("staticHome")})}}}),e.state("home",{url:"/",parent:"root",templateUrl:"pages/home/home.html",controller:"HomeController",resolve:{homeConfig:function(e){var t=Ceres.subscribe("configurations");return e.timeoutPromise(t,5e3)}}}),e.state("staticHome",{url:"/staticHome",templateUrl:"pages/staticHome/staticHome.html",controller:"StaticHomeController"}),e.state("notFound",{url:"/notFound",parent:"root",templateUrl:"pages/notFound/notFound.html"}),e.state("serverProblems",{url:"/serverProblems",parent:"root",templateUrl:"pages/serverProblems/serverProblems.html"}),e.state("profile",{url:"/profile",parent:"root",templateUrl:"pages/profile/profile.html",controller:"ProfileController"}),e.state("user",{url:"/user/:userId",parent:"root",templateUrl:"pages/user/user.html",controller:"UserController",resolve:{userSub:function(e,t){var o=Ceres.subscribe("singleUser",e.userId);return t.timeoutPromise(o,5e3)}}}),e.state("team",{url:"/team",parent:"root",templateUrl:"pages/team/team.html",controller:"TeamController",resolve:{userSub:function(e){var t=Ceres.subscribe("teamUsers");return e.timeoutPromise(t,5e3)}}}),e.state("postView",{url:"/post/:postId",parent:"root",templateUrl:"pages/post/view/postView.html",controller:"PostViewController",resolve:{postSub:function(e,t){var o=Ceres.subscribe("singlePost",e.postId);return t.timeoutPromise(o,5e3)}}}),e.state("postEdit",{url:"/post/:postId/edit",parent:"root",templateUrl:"pages/post/edit/postEdit.html",controller:"PostEditController",resolve:{postSub:function(e,t){var o=Ceres.subscribe("singlePost",e.postId);return t.timeoutPromise(o,5e3)}}}),e.state("postList",{url:"/posts",parent:"root",templateUrl:"pages/post/list/postList.html",controller:"PostListController",resolve:{postSub:function(e){var t=Ceres.subscribe("latestPosts");return e.timeoutPromise(t,5e3)}}}),t.otherwise("/")}]).run(["$rootScope",function(e){e.safeApply=function(t){var o=e.$$phase;"$apply"===o||"$digest"===o?"function"==typeof t&&t():this.$apply(t)},e.Ceres=Ceres,Ceres.subscribe("userAdditionalInfo"),e.Configurations=Ceres.createCollection("configurations"),e.Posts=Ceres.createCollection("posts"),e.Users=Ceres.createCollection("users"),Ceres.on("login",function(t){e.loggedInUserQuery=e.Users.reactiveQuery({_id:t}),e.safeApply(function(){e.user=e.loggedInUserQuery.result[0],e.signedIn=!0}),e.loggedInUserQuery.on("change",function(){e.safeApply(function(){e.user=e.loggedInUserQuery.result[0]})})}),Ceres.on("logout",function(){e.safeApply(function(){delete e.user,e.signedIn=!1})})}]).controller("MainController",["$scope",function(e){e.login=function(){e.Ceres.loginWithTwitter()},e.logout=function(){e.Ceres.logout()}}]),angular.module("mnd-web.components.center",[]).directive("mndCenter",["$timeout",function(e){return{restrict:"A",priority:1e3,compile:function(){return{post:function(t,o){e(function(){var e=o[0],t=e.parentElement,r=parseInt(window.getComputedStyle(e).width,10),n=t.offsetWidth,s=(n-r)/2-50;e.style.marginLeft=s+"px"},0)}}}}}]),angular.module("mnd-web.components.dashboard",[]).controller("SidebarController",["$scope","$state","MndSidebarService",function(e,t,o){e.addPost=function(){var r={userId:e.user._id,map:{},authors:[{userId:e.user._id,screenName:e.user.twitterProfile.screenName,name:e.user.twitterProfile.name,imageUrl:e.user.twitterProfile.pictureUrl}],comments:[],published:!1};e.Posts.insert(r).remote.then(function(r){o.toggleSidebarStatus(),e.$root.$broadcast("sidebarStatusChanged"),t.go("postEdit",{postId:r})},function(e){console.log(e)})},e.closeSidebar=function(){o.toggleSidebarStatus(),e.$root.$broadcast("sidebarStatusChanged")};var r={items:[{title:"Home",href:"/#/",ngClick:"closeSidebar"},{title:"Meet the team",href:"/#/team",ngClick:"closeSidebar"},{title:"Governance",href:"http://www.mondora.com"},{title:"Team",href:"http://www.mondora.com"},{title:"Formazione",href:"http://www.mondora.com"},{title:"Community",href:"http://www.mondora.com"},{title:"My mondora",type:"submenu",items:[{title:"Pomodoro",href:"http://www.mondora.com"},{title:"AaS",href:"http://www.mondora.com"}]}]},n=angular.copy(r);n.items.splice(1,0,{title:"New post",ngClick:"addPost"}),n.items.splice(2,0,{title:"Profile",href:"/#/profile",ngClick:"closeSidebar"}),e.menu=r,e.$watch("user",function(){e.menu=e.user?n:r})}]),angular.module("mnd-web.components.mindmap",[]).directive("mndMindMapRecursive",["RecursionHelper",function(e){return{restrict:"EA",replace:!0,templateUrl:"components/mindmap/mindmaprecursive.html",scope:{map:"=",edit:"=?",child:"=?"},compile:function(t){return e.compile(t,function(e){e.autodestroy=function(){if(e.child){var t=e.$parent.$parent.map.children,o=t.indexOf(e.map);t.splice(o,1)}},e.addChild=function(){e.map||(e.map={}),e.map.children||(e.map.children=[]),e.map.children.push({})}})}}}]).directive("mndMindMap",function(){return{restrict:"EA",replace:!0,templateUrl:"components/mindmap/mindmap.html",scope:{map:"=",edit:"=?",child:"=?"}}}),angular.module("mnd-web.components.tag-strip",[]).factory("MndTagStrippingService",function(){return{strip:function(e){return e.replace(/(<([^>]+)>)/gi," ")}}}),angular.module("mnd-web.pages.home",[]).controller("HomeController",["$scope","$sce",function(e,t){var o=e.Configurations.reactiveQuery({page:"home"}).result[0];e.sprinkleText=o.sprinkleText,e.banner=o.banner,e.login=function(){e.Ceres.loginWithTwitter()};var r="http://mnd-website.s3.amazonaws.com/Mnd-Alps.mp4";e.videoSource=t.trustAsResourceUrl(r);var n="http://s3.amazonaws.com/mnd-website/vd-back.jpg";e.videoPoster=t.trustAsResourceUrl(n)}]),angular.module("mnd-web.pages.profile",[]).controller("ProfileController",["$scope","$interval","$upload",function(e,t,o){e.profile=e.user.profile||{};var r=document.getElementById("profileBioEditor");r.innerHTML=e.user.profile.bio||"";var n={placeholder:"Short bio",buttonLabels:"fontawesome",buttons:["bold","italic","anchor","header1","header2","quote"]};new MediumEditor(r,n),e.clickFileInput=function(){document.querySelector("#profilePictureFileInput").click()},e.abortUpload=function(){e.uploadProgress=0,e.isUploading=!1,e.imageUpload.abort(),delete e.imageUpload},e.onFileSelect=function(t){var r=t[0];if(!/image/g.test(r.type))return void alert("Devi caricare un'immagine.");var n=Math.round(1e16*Math.random()),s=n+"__"+r.name,i={url:"https://ngtest.s3.amazonaws.com/",method:"POST",data:{key:s,acl:"public-read","Content-Type":r.type},file:r};e.isUploading=!0,e.imageUpload=o.upload(i).progress(function(t){e.uploadProgress=parseInt(100*t.loaded/t.total)}).success(function(){e.uploadProgress=100,e.isUploading=!1,e.profile.pictureUrl="https://s3-eu-west-1.amazonaws.com/ngtest/"+s,e.save()})},e.save=function(){e.profile.bio=r.innerHTML,console.log(e.profile),e.Users.update(e.user._id,{profile:e.profile}).remote.fail(function(e){console.log(e)})};var s=t(e.save,5e3);e.$on("$destroy",function(){t.cancel(s)})}]),angular.module("mnd-web.pages.staticHome",[]).controller("StaticHomeController",["$scope","$sce",function(e,t){e.sprinkleText="Essere al passo con i tempi, concreti e con una stretta e profonda visione tecnologica: questo Ã¨ il modo con il quale ci caratterizziamo";var o="http://mnd-website.s3.amazonaws.com/Mnd-Alps.mp4";e.videoSource=t.trustAsResourceUrl(o);var r="http://s3.amazonaws.com/mnd-website/vd-back.jpg";e.videoPoster=t.trustAsResourceUrl(r)}]),angular.module("mnd-web.pages.team",[]).controller("TeamController",["$scope",function(e){var t=e.Users.reactiveQuery({mondoraTeamMember:!0});t.on("change",e.safeApply(function(){e.team=t.result})),e.team=t.result}]),angular.module("mnd-web.pages.user",[]).controller("UserController",["$scope","$stateParams",function(e,t){e.user=e.Users.reactiveQuery({_id:t.userId}).result[0]}]),angular.module("mnd-web.pages.post.edit",[]).controller("PostEditController",["$scope","$interval","$state","$stateParams","$upload",function(e,t,o,r,n){var s=r.postId;if(e.post=e.Posts.reactiveQuery({_id:s}).result[0],!e.post)return void o.go("notFound");var i=document.getElementById("postTitleEditor");i.innerHTML=e.post.title||"";var a={placeholder:"Titolo",disableToolbar:!0,forcePlainText:!0,disableReturn:!0};new MediumEditor(i,a);var l=document.getElementById("postSubtitleEditor");l.innerHTML=e.post.subtitle||"";var u={placeholder:"Sottotitolo",disableToolbar:!0,forcePlainText:!0,disableReturn:!0};new MediumEditor(l,u);var c=document.getElementById("postBodyEditor");c.innerHTML=e.post.body||"";var p={placeholder:"Corpo",buttonLabels:"fontawesome",buttons:["bold","italic","anchor","header1","header2","quote"]};new MediumEditor(c,p),e.toggleDelete=function(){e.showDelete=!e.showDelete},e.deletePost=function(){e.Posts.remove(s).remote.then(function(){o.go("home")},function(){alert("An error occurred.")})},e.publishPost=function(){e.post.published=!0,e.save()},e.unpublishPost=function(){e.post.published=!1,e.save()},e.isOwner=function(){return e.user&&e.post.userId===e.user._id},e.clickFileInput=function(){document.querySelector("#post-edit-image-upload input").click()},e.titleImageIsDisplayed=void 0!==e.post.titleImageUrl,e.abortUpload=function(){e.uploadProgress=0,e.isUploading=!1,e.imageUpload.abort(),delete e.imageUpload},e.onFileSelect=function(t){var o=t[0];if(!/image/g.test(o.type))return void alert("Devi caricare un'immagine.");var r=Math.round(1e16*Math.random()),s=r+"__"+o.name,i={url:"https://ngtest.s3.amazonaws.com/",method:"POST",data:{key:s,acl:"public-read","Content-Type":o.type},file:o};e.isUploading=!0,e.imageUpload=n.upload(i).progress(function(t){e.uploadProgress=parseInt(100*t.loaded/t.total)}).success(function(){e.uploadProgress=100,e.isUploading=!1,e.post.titleImageUrl="https://s3-eu-west-1.amazonaws.com/ngtest/"+s,e.titleImageIsDisplayed=!0,e.save()})},e.save=function(){e.post.title=i.innerHTML,e.post.subtitle=l.innerHTML,e.post.body=c.innerHTML;var t=angular.copy(e.post);delete t._id,delete t.userId,e.Posts.update(s,t).remote.fail(function(e){console.log(e)})};var m=t(e.save,5e3);e.$on("$destroy",function(){t.cancel(m)})}]),angular.module("mnd-web.pages.post.list",[]).controller("PostListController",["$scope",function(e){e.posts=e.Posts.db.itemsArray}]),angular.module("mnd-web.pages.post.view",[]).factory("firstLevelHtmlParser",function(){var e=function(e){var t=document.createElement("div");t.innerHTML=e;var o=Array.prototype.map.call(t.children,function(e){return e.outerHTML});return o};return{parse:e}}).factory("readTimeEstimatingService",["MndTagStrippingService",function(e){var t=function(t){var o=e.strip(t);o=o.replace(/\s+/g," ");var r=o.split(" ").length,n=250;return Math.round(r/n)};return{estimate:t}}]).directive("readonlyEditor",function(){var e=function(e){this.button=document.createElement("button"),this.button.className="medium-editor-action",this.button.innerHTML='<i class="fa fa-twitter"></i>',this.button.target="_blank",this.button.onclick=function(){var t="https://twitter.com/intent/tweet?text=",o='"'+window.getSelection().toString()+'" - @';o+=e+" "+window.location.href;var r=t+o,n=window.open(r,"popup","height=420,width=550");n.focus||n.focus()}};return e.prototype.getButton=function(){return this.button},{link:function(t,o){var r={placeholder:"",disableEditing:!0,buttons:["tweet"],extensions:{tweet:new e}};o[0].innerHTML=t.child,new MediumEditor(o[0],r)}}}).filter("filterCommentsByParagraph",function(){return function(e,t){var o=[];return e.forEach(function(e){e.paragraph===t&&o.push(e)}),o}}).filter("filterCommentsByApprovalStatus",function(){return function(e,t){var o=[];return e.forEach(function(e){(e.approved||e.userId===t)&&o.push(e)}),o}}).controller("PostViewController",["$scope","$stateParams","$state","$filter","MndTagStrippingService","firstLevelHtmlParser","readTimeEstimatingService",function(e,t,o,r,n,s,i){var a=t.postId,l=e.Posts.reactiveQuery({_id:a});return l.on("change",function(){e.safeApply(function(){e.post=l.result[0]})}),e.post=l.result[0],e.post?(e.bodyChildren=function(){return e.post?s.parse(e.post.body):void 0},e.sprinklePostText=function(){return e.post?e.post.body?n.strip(e.post.body):"":void 0},e.estimateReadingTime=function(){return e.post?e.post.body?i.estimate(e.post.body):0:void 0},e.titleImageIsDisplayed=function(){return e.post?void 0!==e.post.titleImageUrl:void 0},e.isAuthor=function(){if(e.post){var t=!1;return e.user&&e.post.authors.forEach(function(o){o.userId===e.user._id&&(t=!0)}),t}},e.commentBarStatus=[],e.closeCommentBar=function(){e.commentBarIsOpen=!1,e.commentBarStatus=[]},e.openCommentBarAt=function(t){e.commentBarIsOpen=!0,e.commentBarStatus[t]=!0},e.commentBarIsOpenAt=function(t){return e.commentBarStatus[t]},e.ownsComment=function(t){return e.user?t.userId===e.user._id:void 0},e.paragraphHasComments=function(t){if(e.post){var o=r("filterCommentsByParagraph")(e.post.comments,t);if(e.isAuthor())return o.length>0;var n=r("filterCommentsByApprovalStatus")(o,e.user._id);return n.length>0}},e.paragraphCommentsLength=function(t){if(e.post){var o=r("filterCommentsByParagraph")(e.post.comments,t);if(e.isAuthor())return o.length;var n=r("filterCommentsByApprovalStatus")(o,e.user._id);return n.length}},e.comment={},e.deleteComment=function(t){var o=e.Ceres.call("deleteCommentFromPost",a,t._id);o.updated.then(function(){e.post=e.Posts.db.get(a),e.$apply()})},e.publishComment=function(t){e.Ceres.call("publishCommentOfPost",a,t._id)},void(e.saveCommentAt=function(t){e.comment.paragraph=t,e.Ceres.call("addCommentToPost",a,e.comment),e.comment.text=""})):void o.go("notFound")}]);